name: Integration Tests

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    services:
      # Note: In production, you'd spin up ERPNext container here
      # For now, this assumes ERPNext is available at a test URL
      erpnext:
        image: frappe/erpnext:latest
        ports:
          - 8080:8000
        options: >-
          --health-cmd "curl -f http://localhost:8000/api/method/frappe.auth.get_logged_user || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for ERPNext to be ready
        run: |
          timeout 300 bash -c 'until curl -f http://localhost:8080/api/method/ping; do sleep 5; done'

      - name: Setup test data in ERPNext
        run: |
          # In production, you'd seed test data here
          echo "Seeding test data..."
          # python scripts/seed_test_data.py

      - name: Run integration tests
        env:
          RUN_INTEGRATION: 1
          ERPNEXT_BASE_URL: http://localhost:8080
          ERPNEXT_API_KEY: ${{ secrets.ERPNEXT_API_KEY }}
          ERPNEXT_API_SECRET: ${{ secrets.ERPNEXT_API_SECRET }}
        run: |
          pytest tests/integration/ -v --maxfail=3

      - name: Archive integration test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: |
            pytest-report.html
            logs/

  e2e-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright
        run: |
          playwright install chromium
          playwright install-deps

      - name: Start OTP service
        run: |
          uvicorn src.main:app --host 0.0.0.0 --port 8001 &
          sleep 5

      - name: Run E2E tests
        env:
          ERPNEXT_BASE_URL: http://localhost:8080
          ERPNEXT_TEST_USERNAME: Administrator
          ERPNEXT_TEST_PASSWORD: ${{ secrets.ERPNEXT_TEST_PASSWORD }}
        run: |
          pytest tests/e2e/ -v --headed=false --screenshot=on --video=on
        continue-on-error: true

      - name: Archive E2E artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-artifacts
          path: |
            test-results/
            playwright-report/
